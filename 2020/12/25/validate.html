<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Validate Component - LiuZheng&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="google-site-verification" content="7if7tEoBzofIpEcyTBbXYj68Uwni_Udf_J_RnIMKkx0"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/article.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container"><div id="nav"><nav id="nav-wrap"><a class="nav-link" href="/">Home</a> <a class="nav-link" href="/archives">Archives</a> <a class="nav-link" href="/categories">Categories</a> <a class="nav-link" href="https://liuzane.github.io/tools">Tools</a> <a class="nav-link" href="/about">About</a></nav><div class="frosted-glass"></div></div><div id="wrapper"><header id="header"><div class="header-wrapper"><img src="/images/aodamiao.jpg" class="header-avatar"><p class="header-author">Zheng Liu</p><p class="header-description">Study hard and make progress every day</p></div><div class="frosted-glass"></div></header><section id="content"><article class="article"><a class="article-back" href="javascript: history.back(-1)">&lt; Back</a><header class="article-header"><h1 class="article-title">Validate Component</h1><div class="article-meta"><time datetime="2020-12-25T07:19:12.000Z" class="article-date">2020-12-25</time></div></header><div class="article-content"><h3 id="自定义验证组件"><a href="#自定义验证组件" class="headerlink" title="自定义验证组件"></a>自定义验证组件</h3><ul><li><p>Plugin</p><table><thead><tr><th>Name</th><th>Link</th></tr></thead><tbody><tr><td>prop-types</td><td><a target="_blank" rel="noopener" href="https://github.com/facebook/prop-types">https://github.com/facebook/prop-types</a></td></tr><tr><td>immutable</td><td><a target="_blank" rel="noopener" href="https://github.com/immutable-js/immutable-js">https://github.com/immutable-js/immutable-js</a></td></tr><tr><td>lodash</td><td><a target="_blank" rel="noopener" href="https://www.lodashjs.com">https://www.lodashjs.com</a></td></tr></tbody></table></li><li><p>Usage</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Desktop</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      <span class="attr">model</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">phone</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">rules</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">          <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;Please type name&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">phone</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Please type phone&#x27;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="function"><span class="title">validator</span>(<span class="params">rule, value, callback</span>)</span> &#123;</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">&#x27;rule&#x27;</span>, rule);</span><br><span class="line">              <span class="built_in">console</span>.log(<span class="string">&#x27;value&#x27;</span>, value);</span><br><span class="line">              <span class="keyword">if</span> (!<span class="regexp">/^1\d&#123;10&#125;$/</span>.test(value)) &#123;</span><br><span class="line">                callback(<span class="string">&#x27;Please type the correct phone, inside&#x27;</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                callback();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Please type the correct phone, outside&#x27;</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onSetValue = <span class="function">(<span class="params">key, e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> value = e.target.value;</span><br><span class="line">    <span class="keyword">const</span> model = _.cloneDeep(<span class="built_in">this</span>.state.model);</span><br><span class="line">    model[key] = value;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; model &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleValidate = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    Validate.validate(<span class="function">(<span class="params">error, model</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;error&#x27;</span>, error);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;model&#x27;</span>, model);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; model, rules &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">LayContainer</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Validate</span> <span class="attr">model</span>=<span class="string">&#123;model&#125;</span> <span class="attr">rules</span>=<span class="string">&#123;rules&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          &#123;</span></span><br><span class="line"><span class="xml">            (messages) =&gt; (</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;validate-wrap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;validate-row&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                  <span class="tag">&lt;<span class="name">Input</span> <span class="attr">value</span>=<span class="string">&#123;model.name&#125;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Please type name&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.onSetValue.bind(this,</span> &#x27;<span class="attr">name</span>&#x27;)&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">                  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;messages.name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;validate-row&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                  <span class="tag">&lt;<span class="name">Input</span> <span class="attr">value</span>=<span class="string">&#123;model.phone&#125;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Please type phone&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.onSetValue.bind(this,</span> &#x27;<span class="attr">phone</span>&#x27;)&#125;/&gt;</span></span></span><br><span class="line"><span class="xml">                  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;messages.phone&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleValidate&#125;</span>&gt;</span>验证<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )</span></span><br><span class="line"><span class="xml">          &#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Validate</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">LayContainer</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Validate.jsx</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 基础模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">&#x27;prop-types&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三方模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; fromJS, is &#125; <span class="keyword">from</span> <span class="string">&#x27;immutable&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validate</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">    <span class="attr">model</span>: PropTypes.object,</span><br><span class="line">    <span class="attr">rules</span>: PropTypes.object,</span><br><span class="line">    <span class="attr">children</span>: PropTypes.func,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      <span class="attr">messages</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">originalModel</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">isValidated</span>: &#123;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    Validate.validate = <span class="built_in">this</span>.validate;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化设置原始model数据</span></span><br><span class="line">  <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; model &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">originalModel</span>: model &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果更新了 model 就获取 messages</span></span><br><span class="line">  <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is(fromJS(<span class="built_in">this</span>.props.model), fromJS(nextProps.model))) &#123;</span><br><span class="line">      <span class="keyword">const</span> messages = <span class="built_in">this</span>.getValidateMessages(nextProps.model);</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123; messages &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  shouldComponentUpdate (nextProps, nextState) &#123;</span><br><span class="line">    <span class="keyword">return</span> !is(fromJS(<span class="built_in">this</span>.props), fromJS(nextProps)) || !is(fromJS(<span class="built_in">this</span>.state), fromJS(nextState));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证规则项</span></span><br><span class="line">  validateRuleItem = <span class="function">(<span class="params">rule, value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rule.required &amp;&amp; !value) &#123;</span><br><span class="line">      <span class="keyword">return</span> rule.message;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (rule.validator) &#123;</span><br><span class="line">      <span class="keyword">let</span> message;</span><br><span class="line">      <span class="keyword">const</span> callback = <span class="function"><span class="params">errorMsg</span> =&gt;</span> &#123;</span><br><span class="line">        message = errorMsg || rule.message;</span><br><span class="line">      &#125;;</span><br><span class="line">      rule.validator(rule, value, callback);</span><br><span class="line">      <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取验证错误信息</span></span><br><span class="line">  getValidateMessages = <span class="function">(<span class="params">model, isValidate</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> messages = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> &#123; rules &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; originalModel, isValidated &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> rules) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isValidate || (model[key] !== <span class="literal">undefined</span> &amp;&amp; (model[key] !== originalModel[key] || isValidated[key]))) &#123;</span><br><span class="line">        <span class="comment">// 计算 key 更新次数</span></span><br><span class="line">        isValidated[key] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果规则项是数组</span></span><br><span class="line">        <span class="keyword">if</span> (_.isArray(rules[key])) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rules[key].length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> message = <span class="built_in">this</span>.validateRuleItem(rules[key][i], model[key]);</span><br><span class="line">            <span class="keyword">if</span> (message) &#123;</span><br><span class="line">              messages[key] = message;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果规则项是对象</span></span><br><span class="line">        <span class="keyword">if</span> (_.isPlainObject(rules[key])) &#123;</span><br><span class="line">          <span class="keyword">const</span> message = <span class="built_in">this</span>.validateRuleItem(rules[key], model[key]);</span><br><span class="line">          <span class="keyword">if</span> (message) messages[key] = message;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; <span class="attr">countModel</span>: _.cloneDeep(isValidated) &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> messages;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 外部调用验证方法</span></span><br><span class="line">  validate = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; model &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> messages = <span class="built_in">this</span>.getValidateMessages(model, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">const</span> error = <span class="built_in">Object</span>.keys(messages).length &gt; <span class="number">0</span> ? messages : <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123; messages &#125;);</span><br><span class="line">    callback(error, model);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; children &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; messages &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> children(messages);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Validate;</span><br></pre></td></tr></table></figure></li></ul></div></article></section><footer id="footer"><div class="footer-wrapper"><a href="/" class="footer-title">LiuZheng's Blog</a><p>Theme from by Lite</p></div><div class="frosted-glass"></div></footer></div></div></body></html>